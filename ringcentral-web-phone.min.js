!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("sip.js"),require("getstats")):"function"==typeof define&&define.amd?define(["sip.js","getstats"],t):"object"==typeof exports?exports.WebPhone=t(require("sip.js"),require("getstats")):(e.RingCentral=e.RingCentral||{},e.RingCentral.WebPhone=t(e.SIP,e.getStats))}(window,function(n,r){return function(n){var r={};function i(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}return i.m=n,i.c=r,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=3)}([function(e,t){e.exports=n},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.messages={park:{reqid:1,command:"callpark"},startRecord:{reqid:2,command:"startcallrecord"},stopRecord:{reqid:3,command:"stopcallrecord"},flip:{reqid:3,command:"callflip",target:""},monitor:{reqid:4,command:"monitor"},barge:{reqid:5,command:"barge"},whisper:{reqid:6,command:"whisper"},takeover:{reqid:7,command:"takeover"},toVoicemail:{reqid:11,command:"toVoicemail"},ignore:{reqid:12,command:"ignore"},receiveConfirm:{reqid:17,command:"receiveConfirm"},replyWithMessage:{reqid:14,command:"replyWithMessage"}},t.uuidKey="rc-webPhone-uuid",t.responseTimeout=6e4,t.defaultMediaConstraints={audio:!0,video:!1}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})},i=this&&this.__generator||function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},o=this;Object.defineProperty(t,"__esModule",{value:!0}),t.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},t.delay=function(t){return r(o,void 0,void 0,function(){return i(this,function(e){return[2,new Promise(function(e){return setTimeout(e,t)})]})})},t.extend=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),Object.assign(e||{},t||{})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var m=n(4),g=n(0),v=n(1),b=n(2),y=n(10).version,r=function(){function e(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.sipInfo=e.sipInfo[0]||e.sipInfo,this.sipFlags=e.sipFlags,this.uuidKey=t.uuidKey||v.uuidKey;var n=t.uuid||localStorage.getItem(this.uuidKey)||b.uuid();localStorage.setItem(this.uuidKey,n),this.appKey=t.appKey,this.appName=t.appName,this.appVersion=t.appVersion;var r=navigator.userAgent.match(/\((.*?)\)/),i=(r&&r.length&&r[1]).replace(/[^a-zA-Z0-9.:_]+/g,"-")||"",o=(t.appName?t.appName+(t.appVersion?"/"+t.appVersion:"")+" ":"")+(i||"")+" RCWEBPHONE/"+y,s=t.modifiers||[];s.push(g.Web.Modifiers.stripG722),s.push(g.Web.Modifiers.stripTcpCandidates);var a="plan-b";t.enableUnifiedSDP&&(a="unified-plan"),t.enableMidLinesInSDP&&s.push(g.Web.Modifiers.addMidLines);var c=t.sessionDescriptionHandlerFactoryOptions||{peerConnectionOptions:{iceCheckingTimeout:this.sipInfo.iceCheckingTimeout||this.sipInfo.iceGatheringTimeout||500,rtcConfiguration:{rtcpMuxPolicy:"negotiate",sdpSemantics:a}},constraints:t.mediaConstraints||v.defaultMediaConstraints,modifiers:s},u=navigator.userAgent.toLowerCase(),l=!1;-1<u.indexOf("safari")&&u.indexOf("chrome")<0||-1<u.indexOf("firefox")&&u.indexOf("chrome")<0&&(l=!0),l&&(c.alwaysAcquireMediaFirst=!0);var d=t.sessionDescriptionHandlerFactory||[],p=e.sipErrorCodes&&e.sipErrorCodes.length?e.sipErrorCodes:["408","502","503"],h=[];this.sipInfo.outboundProxy&&this.sipInfo.transport&&h.push({wsUri:this.sipInfo.transport.toLowerCase()+"://"+this.sipInfo.outboundProxy,weight:10}),this.sipInfo.outboundProxyBackup&&this.sipInfo.transport&&h.push({wsUri:this.sipInfo.transport.toLowerCase()+"://"+this.sipInfo.outboundProxyBackup,weight:0}),h=h.length?h:this.sipInfo.wsServers;var f={uri:"sip:"+this.sipInfo.username+"@"+this.sipInfo.domain,transportOptions:{wsServers:h,traceSip:!0,maxReconnectionAttempts:1===h.length?5:3,reconnectionTimeout:1===h.length?5:3,connectionTimeout:5},authorizationUser:this.sipInfo.authorizationId,password:this.sipInfo.password,stunServers:this.sipInfo.stunServers||["stun:74.125.194.127:19302"],turnServers:[],log:{level:t.logLevel||1,builtinEnabled:t.builtinEnabled||!0,connector:t.connector||null},domain:this.sipInfo.domain,autostart:!1,register:!0,userAgentString:o,sessionDescriptionHandlerFactoryOptions:c,sessionDescriptionHandlerFactory:d};t.sipErrorCodes=p,t.switchBackInterval=this.sipInfo.switchBackInterval,this.userAgent=m.patchUserAgent(new g.UA(f),this.sipInfo,t,n)}return e.version="0.7.0",e.uuid=b.uuid,e.delay=b.delay,e.extend=b.extend,e}();t.default=r},function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=n(5),s=n(6),a=n(9);function c(e){return e.body=e.body||"",'<Msg><Hdr SID="'+e.sid+'" Req="'+e.request+'" From="'+e.from+'" To="'+e.to+'" Cmd="'+e.reqid+'"/> <Bdy Cln="'+this.sipInfo.authorizationId+'" '+e.body+"/></Msg>"}function u(t,i){var o=this,s={contentType:"x-rc/agent",extraHeaders:[]};return s.extraHeaders.push("P-rc-ws: "+this.contact),new Promise(function(n,r){var e=o.message(t,i,s);e.once("accepted",function(e,t){return n(e)}),e.once("failed",function(e,t){return r(new Error(t))})})}t.patchUserAgent=function(n,e,t,r){return n.defaultHeaders=["P-rc-endpoint-id: "+r,"Client-id:"+t.appKey],n.media={},n.enableQos=t.enableQos,n.qosCollectInterval=t.qosCollectInterval||5e3,t.media&&t.media.remote&&t.media.local?(n.media.remote=t.media.remote,n.media.local=t.media.local):n.media=null,n.sipInfo=e,n.__invite=n.invite,n.invite=function(e,t){void 0===t&&(t={});t.extraHeaders=(t.extraHeaders||[]).concat(this.defaultHeaders),t.extraHeaders.push("P-Asserted-Identity: sip:"+(t.fromNumber||this.sipInfo.username)+"@"+this.sipInfo.domain),t.homeCountryId&&t.extraHeaders.push("P-rc-country-id: "+t.homeCountryId);return t.RTCConstraints=t.RTCConstraints||{optional:[{DtlsSrtpKeyAgreement:"true"}]},console.log(t),this.audioHelper.playOutgoing(!0),s.patchSession(this.__invite(e,t))}.bind(n),n.__register=n.register,n.register=function(e){void 0===e&&(e={});return this.__register.call(this,i({},e,{extraHeaders:(e.extraHeaders||[]).concat(this.defaultHeaders)}))}.bind(n),n.__unregister=n.unregister,n.unregister=function(e){void 0===e&&(e={});return this.__unregister.call(this,i({},e,{extraHeaders:(e.extraHeaders||[]).concat(this.defaultHeaders)}))}.bind(n),n.audioHelper=new o.AudioHelper(t.audioHelper),n.__transportConstructor=n.configuration.transportConstructor,n.configuration.transportConstructor=a.TransportConstructorWrapper(n.__transportConstructor,t),n.onSession=t.onSession||null,n.createRcMessage=c,n.sendMessage=u,n.__onTransportConnected=n.onTransportConnected,n.onTransportConnected=function(){if(this.configuration.register)return this.register()}.bind(n),n.on("invite",function(t){n.audioHelper.playIncoming(!0),s.patchSession(t),s.patchIncomingSession(t),t._sendReceiveConfirmPromise=t.sendReceiveConfirm().then(function(){t.logger.log("sendReceiveConfirm success")}).catch(function(e){throw t.logger.error("failed to send receive confirmation via SIP MESSAGE due to "+e),e})}),n.on("registrationFailed",function(e){if(e){var t=e.data||e;t&&"string"==typeof t&&n.transport.isSipErrorCode(t)&&n.transport.onSipErrorCode()}}),n.start(),n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){void 0===e&&(e={}),this._enabled=!!e.enabled,this.loadAudio(e)}return e.prototype._playSound=function(e,t,n){if(!this._enabled||!e)return this;if(this._audio[e])if(t)this._audio[e].currentTime=0,this._audio[e].playPromise=this._audio[e].play();else{var r=this._audio[e];void 0!==r.playPromise&&r.playPromise.then(function(){r.pause()})}else t&&(this._audio[e]=new Audio,this._audio[e].src=e,this._audio[e].loop=!0,this._audio[e].volume=n,this._audio[e].playPromise=this._audio[e].play());return this},e.prototype.loadAudio=function(e){this._incoming=e.incoming,this._outgoing=e.outgoing,this._audio={}},e.prototype.setVolume=function(e){for(var t in e<0&&(e=0),1<e&&(e=1),this.volume=e,this._audio)this._audio.hasOwnProperty(t)&&(this._audio[t].volume=e)},e.prototype.playIncoming=function(e){return this._playSound(this._incoming,e,this.volume||.5)},e.prototype.playOutgoing=function(e){return this._playSound(this._outgoing,e,this.volume||1)},e}();t.AudioHelper=r},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})},a=this&&this.__generator||function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0});var d=n(0),p=n(1),r=n(7),h=n(2);t.patchSession=function(n){if(n.__patched)return n;n.__patched=!0,n.__sendRequest=n.sendRequest,n.__receiveRequest=n.receiveRequest,n.__accept=n.accept,n.__hold=n.hold,n.__unhold=n.unhold,n.__dtmf=n.dtmf,n.__reinvite=n.reinvite,n.sendRequest=function(e,t){return e!==d.C.PRACK?this.__sendRequest(e,t):this}.bind(n),n.receiveRequest=function(e){switch(e.method){case d.C.INFO:if(this.emit("RC_SIP_INFO",e),this.status===d.Session.C.STATUS_CONFIRMED||this.status===d.Session.C.STATUS_WAITING_FOR_ACK){var t=e.getHeader("content-type");if(t.match(/^application\/json/i))return e.reply(200),this}}return this.__receiveRequest.apply(this,arguments)}.bind(n),n.accept=function(i){var o=this;void 0===i&&(i={});return(i=i||{}).extraHeaders=(i.extraHeaders||[]).concat(this.ua.defaultHeaders),i.RTCConstraints=i.RTCConstraints||{optional:[{DtlsSrtpKeyAgreement:"true"}]},new Promise(function(e,t){var n=function(){e(o),o.removeListener("failed",r)},r=function(e){t(e),o.removeListener("accepted",n)};o.once("accepted",n),o.once("failed",r),o.__accept(i)})}.bind(n),n.hold=function(){return y(this,!0)}.bind(n),n.unhold=function(){return y(this,!1)}.bind(n),n.dtmf=function(e,t){void 0===t&&(t=1e3);t=parseInt(t.toString());var n=this.sessionDescriptionHandler.peerConnection.getSenders().find(function(e){return e.track&&"audio"===e.track.kind}).dtmf;if(void 0!==n&&n)return n.insertDTMF(e,t);var r=n&&!n.canInsertDTMF?"can't insert DTMF":"Unknown";throw new Error("Send DTMF failed: "+(n?r:"no sender"))}.bind(n),n.reinvite=function(e,t){void 0===e&&(e={});void 0===t&&(t=null);return e.sessionDescriptionHandlerOptions=e.sessionDescriptionHandlerOptions||{},this.__reinvite(e,t)}.bind(n),n.warmTransfer=function(n,r){void 0===r&&(r={});return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return[4,this.local_hold?Promise.resolve(null):this.hold()];case 1:return e.sent(),[4,h.delay(300)];case 2:return e.sent(),t="<"+n.dialog.remoteTarget.toString()+"?Replaces="+n.dialog.id.callId+"%3Bto-tag%3D"+n.dialog.id.remoteTag+"%3Bfrom-tag%3D"+n.dialog.id.localTag+">",r.extraHeaders=(r.extraHeaders||[]).concat(this.ua.defaultHeaders),[2,this.refer(t,r)]}})})}.bind(n),n.blindTransfer=function(e,t){void 0===t&&(t={});return Promise.resolve(this.refer(e,t))}.bind(n),n.transfer=function(t,n){return s(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return[4,this.local_hold?Promise.resolve(null):this.hold()];case 1:return e.sent(),[4,h.delay(300)];case 2:return e.sent(),[2,this.blindTransfer(t,n)]}})})}.bind(n),n.park=function(){return v(this,p.messages.park)}.bind(n),n.forward=function(r,i,o){return s(this,void 0,void 0,function(){var t,n=this;return a(this,function(e){switch(e.label){case 0:return t=null,[4,this.accept(i)];case 1:return e.sent(),[2,new Promise(function(e){t=setInterval(function(){n.status===d.Session.C.STATUS_CONFIRMED&&(clearInterval(t),n.mute(),setTimeout(function(){e(n.transfer(r,o))},700))},50)})]}})})}.bind(n),n.startRecord=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,b(this,!0)]})})}.bind(n),n.stopRecord=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,b(this,!1)]})})}.bind(n),n.flip=function(t){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,v(this,p.messages.flip,{target:t})]})})}.bind(n),n.mute=function(e){if(this.status!==d.Session.C.STATUS_CONFIRMED)return void this.logger.warn("An acitve call is required to mute audio");this.logger.log("Muting Audio"),e||this.emit("muted",this);return _(this,!0)}.bind(n),n.unmute=function(e){if(this.status!==d.Session.C.STATUS_CONFIRMED)return void this.logger.warn("An active call is required to unmute audio");this.logger.log("Unmuting Audio"),e||this.emit("unmuted",this);return _(this,!1)}.bind(n),n.onLocalHold=function(){return this.local_hold}.bind(n),n.media=n.ua.media,n.addTrack=w.bind(n),n.on("replaced",t.patchSession),n.on("progress",function(t){e(),183===t.statusCode&&(n.createDialog(t,"UAC"),n.hasAnswer=!0,n.status=d.Session.C.STATUS_EARLY_MEDIA,n.sessionDescriptionHandler.setDescription(t.body).catch(function(e){n.logger.warn(e),n.failed(t,d.C.causes.BAD_MEDIA_DESCRIPTION),n.terminate({status_code:488,reason_phrase:"Bad Media Description"})}))}),n.media&&n.on("trackAdded",w);var e=function(){n.ua.audioHelper.playOutgoing(!1),n.ua.audioHelper.playIncoming(!1),n.removeListener("accepted",e),n.removeListener("rejected",e),n.removeListener("bye",e),n.removeListener("terminated",e),n.removeListener("cancel",e),n.removeListener("failed",e),n.removeListener("replaced",e)};return n.on("accepted",e),n.on("rejected",e),n.on("bye",e),n.on("terminated",e),n.on("cancel",e),n.on("failed",e),n.on("replaced",e),n.ua.enableQos&&n.on("SessionDescriptionHandler-created",function(){n.logger.log("SessionDescriptionHandler Created"),r.startQosStatsCollection(n)}),n.ua.onSession&&n.ua.onSession(n),n},t.patchIncomingSession=function(t){try{i(t)}catch(e){t.logger.error("Can't parse RC headers from invite request due to "+e)}t.canUseRCMCallControl=o,t.createSessionMessage=c,t.sendSessionMessage=l,t.sendReceiveConfirm=f,t.ignore=u,t.toVoicemail=m,t.replyWithMessage=g};var i=function(e){var t=e.request.headers["P-Rc"],n=e.request.headers["P-Rc-Api-Call-Info"];if(t&&t.length){var r=t[0].raw,i=(new DOMParser).parseFromString(r,"text/xml"),o=i.getElementsByTagName("Hdr")[0],s=i.getElementsByTagName("Bdy")[0];o&&(e.rcHeaders={sid:o.getAttribute("SID"),request:o.getAttribute("Req"),from:o.getAttribute("From"),to:o.getAttribute("To")}),s&&h.extend(e.rcHeaders,{srvLvl:s.getAttribute("SrvLvl"),srvLvlExt:s.getAttribute("SrvLvlExt"),toNm:s.getAttribute("ToNm")})}if(n&&n.length){var a=n[0].raw,c=a&&a.split(";").map(function(e){return e.trim().split("=")}).reduce(function(e,t){return e[t[0]]=t[1],e},{});c&&h.extend(e.rcHeaders,c)}};function o(){return!!this.rcHeaders}function c(e){if(this.rcHeaders)return h.extend(e,{sid:this.rcHeaders.sid,request:this.rcHeaders.request,from:this.rcHeaders.to,to:this.rcHeaders.from}),this.ua.createRcMessage(e)}function u(){return s(this,void 0,void 0,function(){var t=this;return a(this,function(e){return[2,this._sendReceiveConfirmPromise.then(function(){return t.sendSessionMessage(p.messages.ignore)})]})})}function l(t){return s(this,void 0,void 0,function(){return a(this,function(e){if(!this.rcHeaders)throw new Error("Can't send SIP MESSAGE related to session: no RC headers available");return[2,this.ua.sendMessage(this.rcHeaders.from,this.createSessionMessage(t))]})})}function f(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,this.sendSessionMessage(p.messages.receiveConfirm)]})})}function m(){return s(this,void 0,void 0,function(){var t=this;return a(this,function(e){return[2,this._sendReceiveConfirmPromise.then(function(){return t.sendSessionMessage(p.messages.toVoicemail)})]})})}function g(r){return s(this,void 0,void 0,function(){var t,n=this;return a(this,function(e){return t='RepTp="'+r.replyType+'"',0===r.replyType?t+=' Bdy="'+r.replyText+'"':1===r.replyType&&(t+=' Vl="'+r.timeValue+'"',t+=' Units="'+r.timeUnits+'"',t+=' Dir="'+r.callbackDirection+'"'),[2,this._sendReceiveConfirmPromise.then(function(){return n.sendSessionMessage({reqid:p.messages.replyWithMessage.reqid,body:t})})]})})}function v(u,l,t){return s(this,void 0,void 0,function(){var c;return a(this,function(e){return t=t||{},h.extend(l,t),[2,new Promise(function(s,a){var e=(t.extraHeaders||[]).concat(u.ua.defaultHeaders).concat(["Content-Type: application/json;charset=utf-8"]);u.sendRequest(d.C.INFO,{body:JSON.stringify({request:l}),extraHeaders:e,receiveResponse:function(r){var i=null;if(200===r.statusCode){c=r.cseq;var o=function(e){if(r.cseq===c){var t,n=e&&e.body||"{}";try{t=JSON.parse(n)}catch(e){t={}}if(t.response&&t.response.command===l.command&&t.response.result)return"0"===t.response.result.code.toString()?s(t.response.result):a(t.response.result);i&&clearTimeout(i),u.removeListener("RC_SIP_INFO",o),s(null)}};i=setTimeout(function(){a(new Error("Timeout: no reply")),u.removeListener("RC_SIP_INFO",o)},p.responseTimeout),u.on("RC_SIP_INFO",o)}else a(new Error("The INFO response status code is: "+r.statusCode+" (waiting for 200)"))}})})]})})}function b(r,i){return s(this,void 0,void 0,function(){var t,n;return a(this,function(e){switch(e.label){case 0:return t=i?p.messages.startRecord:p.messages.stopRecord,r.__onRecord&&!i||!r.__onRecord&&i?[4,v(r,t)]:[3,2];case 1:return n=e.sent(),r.__onRecord=!!i,[2,n];case 2:return[2]}})})}function y(t,n){return s(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return n?[4,t.__hold()]:[3,2];case 1:return e.sent(),[3,4];case 2:return[4,t.__unhold()];case 3:e.sent(),e.label=4;case 4:return[2]}})})}function _(e,t){var n=e.sessionDescriptionHandler.peerConnection;n.getSenders&&n.getSenders().forEach(function(e){e.track&&(e.track.enabled=!t)})}function w(e,t){var n,r,i=this,o=this.sessionDescriptionHandler.peerConnection;if(e&&t)n=e,r=t;else{if(!this.media)throw new Error("HTML Media Element not Defined");n=this.media.remote,r=this.media.local}var s=new MediaStream;o.getReceivers?o.getReceivers().forEach(function(e){var t=e.track;t&&s.addTrack(t)}):s=o.getRemoteStreams()[0],n.srcObject=s,n.play().catch(function(){i.logger.log("local play was rejected")});var a=new MediaStream;o.getSenders?o.getSenders().forEach(function(e){var t=e.track;t&&"audio"===t.kind&&a.addTrack(t)}):a=o.getLocalStreams()[0],r.srcObject=a,r.play().catch(function(){i.logger.log("local play was rejected")})}},function(e,t,n){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=i(n(8)),a=function(e){return parseFloat(e.toString()).toFixed(2)};t.startQosStatsCollection=function(e){var n,r=h();if(r.callID=e.request.callId||"",r.fromTag=e.request.fromTag||"",r.toTag=e.request.toTag||"",r.localID=e.request.headers.From[0].raw||e.request.headers.From[0],r.remoteID=e.request.headers.To[0].raw||e.request.headers.To[0],r.origID=e.request.headers.From[0].raw||e.request.headers.From[0],!o.default)throw new Error("getStats module was not provided!");o.default(e.sessionDescriptionHandler.peerConnection,function(e){n=e,r.status=!0;var t=m(n.connectionType);r.localAddr=n.connectionType.local.ipAddress[0],r.remoteAddr=n.connectionType.remote.ipAddress[0],n.results.forEach(function(e){"ssrc"===e.type&&"Channel-audio-1"===e.transportId&&e.id.includes("recv")&&(r.jitterBufferDiscardRate=e.googSecondaryDiscardedRate||0,r.packetLost=e.packetsLost,r.packetsReceived=e.packetsReceived,r.totalSumJitter+=parseFloat(e.googJitterBufferMs),r.totalIntervalCount+=1,r.JBM=Math.max(r.JBM,parseFloat(e.googJitterBufferMs)),r.netType=f(r.netType,t))})},e.ua.qosCollectInterval),e.on("terminated",function(){n&&n.nomore(),u(e,r)})};var s,c,u=function(e,t,n){void 0===n&&(n={}),n=n||{};var r=navigator.connection.effectiveType||"",i=l(t)||"",o=n.targetUrl||"rtcpxr@rtcpxr.ringcentral.com:5060",s=n.event||"vq-rtcpxr";n.expires=60,n.contentType="application/vq-rtcpxr",n.extraHeaders=n.extraHeaders||[],n.extraHeaders.push("p-rc-client-info:cpuRC=0:0;cpuOS=0:0;netType="+i+";ram=0:0;effectiveType="+r);var a=d(t),c=p(a),u=e.ua.publish(o,s,c,n);t.status=!1,u.close(),e.emit("qos-published",c)},l=function(e){for(var t=[],n=0,r=Object.entries(e.netType);n<r.length;n++){var i=r[n],o=i[0],s=i[1];t.push(o+":"+a(100*s/e.totalIntervalCount))}return t.join()},d=function(e){var t=100*e.packetLost/(e.packetsReceived+e.packetLost)||0,n=0<e.totalIntervalCount?e.totalSumJitter/e.totalIntervalCount:0;return r({},e,{NLR:a(t),JBN:a(n),JDR:a(e.jitterBufferDiscardRate),MOSLQ:0})},p=function(e){var t=e.JBM||0,n=e.JBM||0,r=e.JBN||0,i=e.JDR||0,o=e.MOSLQ||0,s=e.callID||"",a=e.fromTag||"",c=e.toTag||"",u=e.localID||"";return"VQSessionReport: CallTerm\r\nCallID: "+s+"\r\nLocalID: "+u+"\r\nRemoteID: "+(e.remoteID||"")+"\r\nOrigID: "+u+"\r\nLocalAddr: IP="+(e.localAddr||"")+" SSRC=0x00000000\r\nRemoteAddr: IP="+(e.remoteAddr||"")+" SSRC=0x00000000\r\nLocalMetrics:\r\nTimestamps: START=0 STOP=0\r\nSessionDesc: PT=0 PD=opus SR=0 FD=0 FPP=0 PPS=0 PLC=0 SSUP=on\r\nJitterBuffer: JBA=0 JBR=0 JBN="+r+" JBM="+n+" JBX=0\r\nPacketLoss: NLR="+t+" JDR="+i+"\r\nBurstGapLoss: BLD=0 BD=0 GLD=0 GD=0 GMIN=0\r\nDelay: RTD=0 ESD=0 SOWD=0 IAJ=0\r\nQualityEst: MOSLQ="+o+" MOSCQ=0.0\r\nDialogID: "+s+";to-tag="+c+";from-tag="+a},h=function(){return{localAddr:"",remoteAddr:"",callID:"",localID:"",remoteID:"",origID:"",fromTag:"",toTag:"",timestamp:{start:"",stop:""},netType:{},packetLost:0,packetsReceived:0,jitterBufferNominal:0,jitterBufferMax:0,jitterBufferDiscardRate:0,totalSumJitter:0,totalIntervalCount:0,NLR:"",JBM:0,JBN:"",JDR:"",MOSLQ:0,status:!1}},f=function(e,t){var n;return void 0===e&&(e={}),r({},e,((n={})[t]=(t in e?parseInt(e[t]):0)+1,n))};(c=s||(s={})).bluetooth="Bluetooth",c.cellular="Cellulars",c.ethernet="Ethernet",c.wifi="WiFi",c.wimax="WiMax",c["2g"]="2G",c["3g"]="3G",c["4g"]="4G";var m=function(e){var t=e.systemNetworkType||"unknown",n=e.local.networkType||["unknown"],r=t&&"unknown"!==t?t:n[0];return r in s?s[r]:r}},function(e,t){e.exports=r},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(o,s,a,c){return new(a||(a=Promise))(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,s||[])).next())})},s=this&&this.__generator||function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.TransportConstructorWrapper=function(r,i){return function(e,t){var n=new r(e,t);return n.nextReconnectInterval=0,n.sipErrorCodes=i.sipErrorCodes,n.switchBackInterval=i.switchBackInterval,n.computeRandomTimeout=c,n.reconnect=function(i){return o(this,void 0,void 0,function(){var t,n,r=this;return s(this,function(e){switch(e.label){case 0:return 0<this.reconnectionAttempts&&this.logger.log("Reconnection attempt "+this.reconnectionAttempts+" failed"),i?(this.logger.log("forcing connect to main WS server"),this.server=this.getNextWsServer(!0),this.reconnectionAttempts=0,[4,this.disconnect({force:!0})]):[3,3];case 1:return e.sent(),[4,this.connect()];case 2:return e.sent(),[2];case 3:return this.noAvailableServers()?(this.logger.warn("no available ws servers left - going to closed state"),this.status=a.STATUS_CLOSED,this.emit("closed"),this.resetServerErrorStatus(),[2]):this.isConnected()?(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),[4,this.disconnect({force:!0})]):[3,5];case 4:return e.sent(),[2];case 5:return t=1e3*(this.configuration.reconnectionTimeout-2),n=1e3*(this.configuration.reconnectionTimeout+2),this.reconnectionAttempts+=1,this.nextReconnectInterval=this.computeRandomTimeout(this.reconnectionAttempts,t,n),this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.wsUri),this.logger.log("transport "+this.server.wsUri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,[4,this.reconnect()]):[3,7];case 6:return e.sent(),[3,8];case 7:this.logger.log("trying to reconnect to WebSocket "+this.server.wsUri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=setTimeout(function(){r.connect(),r.reconnectTimer=void 0},this.nextReconnectInterval),this.logger.warn("next reconnection attempt in:"+Math.round(this.nextReconnectInterval/1e3)+" seconds."),e.label=8;case 8:return[2]}})})}.bind(n),n.isSipErrorCode=function(e){var t=e.substring(0,e.indexOf("\r\n")).split(" ")[1];return t&&this.sipErrorCodes&&this.sipErrorCodes.length&&this.sipErrorCodes.includes(t)}.bind(n),n.scheduleSwithBackMainProxy=function(){var e=this,t=this.switchBackInterval?1e3*this.switchBackInterval:null;if(t){t+=this.computeRandomTimeout(1,0,9e5),this.logger.warn("Try to switch back to main proxy after "+Math.round(t/1e3/60)+" min");var n=this.configuration.wsServers[0];n.switchBackTimer=setTimeout(function(){n.isError=!1,n.switchBackTimer=null,e.emit("switchBackProxy")},t)}else this.logger.warn("switchBackInterval is not set. Will be switched with next provision update ")}.bind(n),n.onSipErrorCode=function(){return o(this,void 0,void 0,function(){return s(this,function(e){switch(e.label){case 0:return this.logger.warn("Error received from the server. Disconnecting from the proxy"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,[4,this.disconnect({force:!0})];case 1:return e.sent(),[2,this.connect()]}})})}.bind(n),n.__isCurrentMainProxy=function(){return this.server===this.configuration.wsServers[0]}.bind(n),n.__afterWSConnected=function(){this.__isCurrentMainProxy()?this.__onConnectedToMain():this.__onConnectedToBackup()}.bind(n),n.__onConnectedToBackup=function(){this.configuration.wsServers[0].switchBackTimer||this.scheduleSwithBackMainProxy()}.bind(n),n.__onConnectedToMain=function(){var e=this.configuration.wsServers[0];e.switchBackTimer&&(clearTimeout(e.switchBackTimer),e.switchBackTimer=null)}.bind(n),n.__on_message_received=function(e){"NOTIFY"===e.method&&this.__on_check_sync_message(e.data)}.bind(n),n.__on_check_sync_message=function(e){e.match(/Event:\s+check-sync/i)&&this.emit("provisionUpdate")}.bind(n),n.on("connected",n.__afterWSConnected),n.on("message",n.__on_message_received),n}};var a={STATUS_CONNECTING:0,STATUS_OPEN:1,STATUS_CLOSING:2,STATUS_CLOSED:3},c=function(e,t,n){if(void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),t<0||n<0||e<1)throw new Error("Arguments must be positive numbers");return Math.floor(Math.random()*Math.abs(n-t))+t+(e-1)*(t+n)/2}},function(e){e.exports={name:"ringcentral-web-phone",version:"0.7.0",scripts:{test:"npm run test:karma && npm run test:e2e","test:watch":"karma start","test:karma":"npm run test:watch -- --single-run","test:coverage":"cat .coverage/lcov.info | coveralls -v","test:e2e":"jest --runInBand",build:"npm run build:tsc && npm run build:webpack","build:tsc":"tsc","build:webpack":"cross-env NODE_ENV=production webpack --config webpack.config.js --progress --color",start:"webpack-dev-server --config webpack.config.js --progress --color",server:"http-server --port ${PORT:-8080}",watch:'npm-run-all --print-label --parallel "build:** -- --watch"',lint:"eslint --cache --cache-location node_modules/.cache/eslint --fix","lint:all":'npm run lint "src/**/*.ts" "demo/**/*.js"',"lint:staged":"lint-staged"},dependencies:{getstats:"^1.2.0","sip.js":"0.13.5"},devDependencies:{"@types/expect-puppeteer":"3.3.1","@types/jest":"24.0.6","@types/jest-environment-puppeteer":"2.2.1","@types/karma":"3.0.2","@types/node":"10.1.4",bootstrap:"3.4.1","cache-loader":"2.0.1","copy-webpack-plugin":"5.0.0",coveralls:"3.0.2","cross-env":"5.2.0",dotenv:"6.2.0",eslint:"5.14.1","eslint-config-ringcentral-typescript":"0.1.0","html-webpack-plugin":"3.2.0","http-server":"0.11.1",husky:"1.3.1","istanbul-instrumenter-loader":"3.0.1","jasmine-core":"3.3.0",jest:"24.5.0","jest-puppeteer":"4.0.0",jquery:"3.3.1",karma:"4.0.0","karma-chrome-launcher":"2.2.0","karma-coverage-istanbul-reporter":"2.0.5","karma-env":"0.1.0","karma-jasmine":"2.0.1","karma-mocha-reporter":"2.2.5","karma-sourcemap-loader":"0.3.7","karma-webpack":"3.0.5","lint-staged":"8.1.4","npm-run-all":"4.1.5",puppeteer:"1.12.2",ringcentral:"3.2.1","ts-jest":"24.0.0","ts-loader":"5.3.3",typescript:"3.3.3","uglifyjs-webpack-plugin":"2.1.1",webpack:"4.29.5","webpack-cli":"3.2.3","webpack-dev-server":"3.2.0"},preferGlobal:!1,private:!1,main:"./lib/index.js",types:"./lib/index.d.ts",author:{name:"RingCentral, Inc.",email:"devsupport@ringcentral.com"},contributors:[{name:"Kirill Konshin"}],repository:{type:"git",url:"git://github.com/ringcentral/ringcentral-web-phone.git"},bugs:{url:"https://github.com/ringcentral/ringcentral-web-phone/issues"},homepage:"https://github.com/ringcentral/ringcentral-web-phone",engines:{node:">=0.10.36"},license:"MIT"}}]).default});